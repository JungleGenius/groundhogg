(function($){async function apiGet(route,params={},opts={}){const response=await fetch(route+"?"+$.param(params),{headers:{"X-WP-Nonce":Groundhogg.nonces._wprest},...opts});return response.json()}async function apiPost(url="",data={},opts={}){const response=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":Groundhogg.nonces._wprest},body:JSON.stringify(data),...opts});return response.json()}async function adminAjax(data={},opts={}){const fData=new FormData;for(const key in data){if(data.hasOwnProperty(key)){fData.append(key,data[key])}}const response=await fetch(ajaxurl,{method:"POST",credentials:"same-origin",body:fData,...opts});return response.json()}async function apiPatch(url="",data={},opts={}){const response=await fetch(url,{...opts,method:"PATCH",headers:{"Content-Type":"application/json","X-WP-Nonce":Groundhogg.nonces._wprest},body:JSON.stringify(data)});return response.json()}async function apiDelete(url="",data={},opts={}){const response=await fetch(url,{...opts,method:"DELETE",headers:{"Content-Type":"application/json","X-WP-Nonce":Groundhogg.nonces._wprest},body:JSON.stringify(data)});return response.json()}const ObjectStore=(route,extra={})=>({primaryKey:"ID",getItemFromResponse:r=>r.item,getItemsFromResponse:r=>r.items,items:[],item:{},route:route,get:function(id){let item;if(this.item[this.primaryKey]===id){item=this.item}else{item=this.items.find(item=>item[this.primaryKey]===id)}return item},getItems:function(){return this.items},hasItem:function(id){return this.item[this.primaryKey]===id||this.items.find(item=>item[this.primaryKey]===id)},hasItems:function(itemIds){if(!itemIds){return this.items.length>0}for(let i=0;i<itemIds.length;i++){const itemId=itemIds[i];if(!this.items.find(item=>{return item[this.primaryKey]===itemId})){return false}}return true},itemsFetched:function(items){this.items=[...items,...this.items.filter(item=>!items.find(_item=>_item[this.primaryKey]===item[this.primaryKey]))]},fetchItems:async function(params){return apiGet(this.route,params).then(r=>this.getItemsFromResponse(r)).then(items=>{this.itemsFetched(items);return items})},fetchItem:async function(id){return apiGet(`${this.route}/${id}`).then(r=>this.getItemFromResponse(r)).then(item=>{this.item=item;this.itemsFetched([item]);return item})},post:async function(data,opts={}){return apiPost(this.route,data,opts).then(r=>this.getItemFromResponse(r)).then(item=>{this.itemsFetched([item]);return item})},patch:async function(id,data,opts={}){return apiPatch(`${this.route}/${id}`,data,opts).then(r=>this.getItemFromResponse(r)).then(item=>{this.item=item;this.itemsFetched([item]);return item})},patchMeta:async function(id,data,opts={}){return apiPatch(`${this.route}/${id}/meta`,data,opts).then(r=>this.getItemFromResponse(r)).then(item=>{this.item=item;this.itemsFetched([item]);return item})},delete:async function(id){if(typeof id==="object"){return this.deleteMany(id)}return apiDelete(`${this.route}/${id}`).then(r=>{if(this.item[this.primaryKey]===id){this.item={}}this.items=[...this.items.filter(item=>item[this.primaryKey]!==id)];return r})},deleteMany:async function(query){return apiDelete(`${this.route}`,query).then(r=>this.getItemsFromResponse(r)).then(items=>{this.items=[...this.items.filter(item=>!items.includes(item[this.primaryKey]))];return items})},...extra});Groundhogg.api.post=apiPost;Groundhogg.api.get=apiGet;Groundhogg.api.patch=apiPatch;Groundhogg.api.delete=apiDelete;Groundhogg.api.ajax=adminAjax;Groundhogg.stores={tags:ObjectStore(Groundhogg.api.routes.v4.tags,{limit:100,offset:0,validate:async function(maybeTags){var self=this;return await apiPost(`${this.route}/validate`,maybeTags).then(r=>{if(!r.items){return[]}self.items=[...r.items,...self.items.filter(item=>!r.items.find(_item=>_item[this.primaryKey]===item[this.primaryKey]))];return r.items})},preloadTags:function(){var self=this;return apiGet(this.route,{limit:self.limit,offet:self.offset}).then(data=>{if(!data.items){return}Object.assign(self.items,data.items);if(data.items.length===self.limit){self.offset+=self.limit;self.preloadTags()}})}}),contacts:ObjectStore(Groundhogg.api.routes.v4.contacts,{count:async function(params){return apiGet(`${this.route}`,{count:true,...params}).then(r=>r.total_items)}}),campaigns:ObjectStore(Groundhogg.api.routes.v4.campaigns),funnels:ObjectStore(Groundhogg.api.routes.v4.funnels,{commit:async function(id,data,opts={}){return apiPost(`${this.route}/${id}/commit`,data,opts).then(r=>this.getItemFromResponse(r)).then(item=>{this.item=item;this.itemsFetched([item]);return item})},isStartingStep:function(funnelId,stepId,checkEdited=false){return!this.getPrecedingSteps(funnelId,stepId,checkEdited).find(_step=>_step.data.step_group==="action")},getSteps:function(funnelId,checkEdited=false){const funnel=funnelId?this.items.find(f=>f.ID===funnelId):this.item;return!checkEdited?funnel.steps:funnel.meta.edited.steps},getFunnelAndStep:function(funnelId,stepId,checkEdited=false){const funnel=funnelId?this.items.find(f=>f.ID===funnelId):this.item;const step=!checkEdited?funnel.steps.find(s=>s.ID===stepId):funnel.meta.edited.steps.find(s=>s.ID===stepId);return{funnel:funnel,step:step}},getProceedingSteps:function(funnelId,stepId,checkEdited=false){const{step:step,funnel:funnel}=this.getFunnelAndStep(funnelId,stepId,checkEdited);return funnel.steps.filter(_step=>_step.data.step_order>step.data.step_order).sort((a,b)=>a.data.step_order-b.data.step_order)},getPrecedingSteps:function(funnelId,stepId,checkEdited=false){const{step:step,funnel:funnel}=this.getFunnelAndStep(funnelId,stepId,checkEdited);return funnel.steps.filter(_step=>_step.data.step_order<step.data.step_order).sort((a,b)=>a.data.step_order-b.data.step_order)}}),emails:ObjectStore(Groundhogg.api.routes.v4.emails),broadcasts:ObjectStore(Groundhogg.api.routes.v4.broadcasts),searches:ObjectStore(Groundhogg.api.routes.v4.searches,{primaryKey:"id"})};Groundhogg.createStore=(id,route="",extra={})=>{const store=ObjectStore(route,extra);Groundhogg.stores[id]=store;return store}})(jQuery);