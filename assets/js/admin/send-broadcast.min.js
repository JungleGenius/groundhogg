(function($){const{modal:modal,select:select,stepNav:stepNav,stepNavHandler:stepNavHandler,input:input,errorDialog:errorDialog,setFrameContent:setFrameContent,progressBar:progressBar,tooltip:tooltip,loadingDots:loadingDots,adminPageURL:adminPageURL,bold:bold,dialog:dialog}=Groundhogg.element;const{emailPicker:emailPicker,searchesPicker:searchesPicker}=Groundhogg.pickers;const{emails:EmailsStore,searches:SearchesStore,contacts:ContactsStore}=Groundhogg.stores;const{routes:routes,post:post}=Groundhogg.api;const{createFilters:createFilters}=Groundhogg.filters.functions;const{formatNumber:formatNumber,formatTime:formatTime,formatDate:formatDate,formatDateTime:formatDateTime}=Groundhogg.formatting;const{sprintf:sprintf,__:__,_x:_x,_n:_n}=wp.i18n;const SendBroadcast=(selector,{email:email=false,...rest}={},{onScheduled:onScheduled=(()=>{})})=>{let state={email_id:email?email.ID:false,when:"now",which:"filters",date:moment().format("YYYY-MM-DD"),time:"09:00:00",query:{},total_contacts:0,...rest};const setState=newState=>{state={...state,...newState};console.log(state)};const elPrefix="gh-broadcast";if(email){EmailsStore.itemsFetched([email])}const preview=()=>`\n\t\t  <div class="gh-row">\n\t\t\t  <div class="gh-col">\n\t\t\t\t  <iframe id="${elPrefix}-email-preview"></iframe>\n\t\t\t  </div>\n\t\t  </div>`;const showFrame=()=>{if(state.email_id){setFrameContent($(`#${elPrefix}-email-preview`)[0],EmailsStore.get(state.email_id).context.built)}};const step1=()=>`\n\t\t  <div class="gh-rows-and-columns">\n\t\t\t  <div class="gh-row">\n\t\t\t\t  <div class="gh-col">\n\t\t\t\t\t  <label for="${elPrefix}-email">${__("Which email do you want to send?","groundhogg")}</label>\n\t\t\t\t\t  ${select({name:"email",id:`${elPrefix}-email`},EmailsStore.getItems().map((e=>({text:e.data.title,value:e.ID}))),state.email_id)}\n\t\t\t\t  </div>\n\t\t\t  </div>\n\t\t\t  ${state.email_id?preview():""}\n\t\t\t  <div class="gh-row">\n\t\t\t\t  <div class="gh-col">\n\t\t\t\t\t  <button class="gh-next-step gh-button primary" ${state.email_id?"":"disabled"}>\n\t\t\t\t\t\t  ${__("Next","groundhogg")} &rarr;\n\t\t\t\t\t  </button>\n\t\t\t\t  </div>\n\t\t\t  </div>\n\t\t  </div>\n      `;const step2=()=>{const laterSettings=()=>`\n\t\t\t<div class="gh-row">\n\t\t\t\t<div class="gh-col">\n\t\t\t\t\t<label for="${elPrefix}-date">${__("Set the date and time...","groundhogg")}</label>\n\t\t\t\t\t<div class="gh-input-group">\n\t\t\t\t\t\t${input({id:`${elPrefix}-date`,type:"date",name:"date",value:state.date,min:moment().format("YYYY-MM-DD")})}\n\t\t\t\t\t\t${input({id:`${elPrefix}-time`,type:"time",name:"time",value:state.time})}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>`;return`\n\t\t  <div class="gh-rows-and-columns">\n\t\t\t  <div class="gh-row">\n\t\t\t\t  <div class="gh-col">\n\t\t\t\t\t  <label for="${elPrefix}-when">${__("When should this email be sent?","groundhogg")}</label>\n\t\t\t\t\t  <div class="gh-radio-group">\n\t\t\t\t\t\t  <label>${input({type:"radio",className:"change-when",name:"gh_send_when",value:"now",checked:state.when==="now"})} ${__("Now","groundhogg")}</label>\n\t\t\t\t\t\t  <label>${input({type:"radio",name:"gh_send_when",className:"change-when",value:"later",checked:state.when==="later"})} ${__("Later","groundhogg")}</label>\n\t\t\t\t\t  </div>\n\n\t\t\t\t  </div>\n\t\t\t  </div>\n\t\t\t  ${state.when==="later"?laterSettings():""}\n\t\t\t  <div class="gh-row">\n\t\t\t\t  <div class="gh-col">\n\t\t\t\t\t  <button class="gh-next-step gh-button primary"\n\t\t\t\t\t          ${state.when==="later"&&(!state.date||!state.time)?"disabled":""}>\n\t\t\t\t\t\t  ${__("Next","groundhogg")} &rarr;\n\t\t\t\t\t  </button>\n\t\t\t\t  </div>\n\t\t\t  </div>`};const step3=()=>{const{total_contacts:total_contacts}=state;const totalAndNext=()=>`\n\t\t\t<div class="gh-row">\n\t\t\t\t<div class="gh-col">\n\t\t\t\t\t<div id="${elPrefix}-total-contacts">\n\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\t${sprintf(_n("Send to %s contact","Send to %s contacts",total_contacts,"groundhogg"),bold(formatNumber(total_contacts)))}\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="gh-row">\n\t\t\t\t<div class="gh-col">\n\t\t\t\t\t<button class="gh-next-step gh-button primary" ${total_contacts?"":"disabled"}>\n\t\t\t\t\t\t${__("Next","groundhogg")}\n\t\t\t\t\t\t&rarr;\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>`;if(state.which==="from_table"){return`<div class="gh-rows-and-columns">${totalAndNext()}</div>`}return`\n\t\t  <div class="gh-rows-and-columns">\n\t\t\t  <div class="gh-row">\n\t\t\t\t  <div class="gh-col">\n\t\t\t\t\t  <label\n\t\t\t\t\t\t  for="${elPrefix}-search-which"><b>${__("Select contacts to receive this email...","groundhogg")}</b></label>\n\t\t\t\t\t  <div class="gh-radio-group">\n\t\t\t\t\t\t  <label>${input({type:"radio",className:"change-search-which",name:"gh_send_search_which",value:"filters",checked:state.which==="filters"})} ${__("Search for Contacts","groundhogg")}</label>\n\t\t\t\t\t\t  <label>${input({type:"radio",name:"gh_send_search_which",className:"change-search-which",value:"searches",checked:state.which==="searches"})} ${__("Use a Saved Search","groundhogg")}</label>\n\t\t\t\t\t  </div>\n\t\t\t\t  </div>\n\t\t\t  </div>\n\t\t\t  <div class="gh-row">\n\t\t\t\t  <div class="gh-col">\n\t\t\t\t\t  <div id="${elPrefix}-search-method">\n\t\t\t\t\t\t  ${state.which==="searches"?select({id:`${elPrefix}-search-method-searches`,name:"searches",dataPlaceholder:__("Please select a saved search...","groundhogg")},SearchesStore.getItems().map((s=>({text:s.name,value:s.id}))),state.query.saved_search):""}\n\t\t\t\t\t  </div>\n\t\t\t\t  </div>\n\t\t\t  </div>\n\t\t\t  ${totalAndNext()}\n\t\t  </div>`};const step4=()=>{const email=EmailsStore.get(state.email_id);const{total_contacts:total_contacts,date:date,time:time}=state;let review=state.when==="later"?_n("Send %1$s to %2$s contact on %3$s","Send %1$s to %2$s contacts on %3$s",total_contacts,"groundhogg"):_n("Send %1$s to %2$s contact <b>immediately</b>.","Send %1$s to %2$s contacts <b>immediately</b>",total_contacts,"groundhogg");return`\n\t\t  <div class="gh-rows-and-columns">\n\t\t\t  <div class="gh-row">\n\t\t\t\t  <div class="gh-col">\n              <span class="gh-text md">\n                  ${sprintf(review,bold(email.data.title),bold(formatNumber(total_contacts)),state.when==="later"?bold(formatDateTime(date+" "+time)):"")}\n              </span>\n\t\t\t\t  </div>\n\t\t\t  </div>\n\t\t\t  ${state.email_id?preview():""}\n\t\t\t  <div class="gh-row">\n\t\t\t\t  <div class="gh-col">\n\t\t\t\t\t  <button id="${elPrefix}-confirm" class="gh-button primary">\n\t\t\t\t\t\t  ${state.when==="later"?__("Confirm and Schedule","groundhogg"):__("Confirm and Send","groundhogg")}\n\t\t\t\t\t  </button>\n\t\t\t\t  </div>\n\t\t\t  </div>\n\t\t  </div>`};$(selector).html(`<div id="gh-send-broadcast-form"></div>`);const{$el:$el,nextStep:nextStep,lastStep:lastStep,setStep:setStep}=stepNavHandler("#gh-send-broadcast-form",{currentStep:0,steps:[step1,step2,step3,step4],showNav:true,labels:[__("Email","groundhogg"),__("Schedule","groundhogg"),__("Contacts","groundhogg"),__("Review","groundhogg")],onStepChange:(step,{nextStep:nextStep,lastStep:lastStep,setStep:setStep})=>{switch(step){case 0:emailPicker(`#${elPrefix}-email`,false,(items=>{EmailsStore.itemsFetched(items)}),{status:"ready"},{placeholder:"Select an email to send..."}).on("change",(({target:target})=>{setState({email_id:parseInt(target.value)});setStep(0);showFrame()}));showFrame();break;case 1:$(".change-when").on("change",(({target:target})=>{setState({when:$(target).val()});setStep(1)}));const updateButton=()=>{const isValid=state.when==="now"||moment().isBefore(`${state.date} ${state.time}`);$(".gh-next-step").prop("disabled",!isValid)};$(`#${elPrefix}-date`).on("change",(({target:target})=>{setState({date:target.value});updateButton()}));$(`#${elPrefix}-time`).on("change",(({target:target})=>{setState({time:target.value});updateButton()}));break;case 2:const updateTotal=()=>{const query={...state.query,marketable:true};ContactsStore.count(query).then((total=>{$(`#${elPrefix}-total-contacts`).html(`<p>${sprintf(_n("Send to %s contact","Send to %s contacts",total,"groundhogg"),bold(formatNumber(total)))}</p>`);$(".gh-next-step").prop("disabled",total===0);setState({total_contacts:total})}))};$(".change-search-which").on("change",(({target:target})=>{setState({which:$(target).val(),query:{}});setStep(2)}));if(state.which==="filters"){createFilters(`#${elPrefix}-search-method`,state.query.filters,(filters=>{setState({query:{filters:filters}});updateTotal()})).mount()}else{searchesPicker(`#${elPrefix}-search-method-searches`,(items=>{SearchesStore.itemsFetched(items)}),{},{placeholder:"Select a saved search..."}).on("select2:select",(({target:target})=>{setState({query:{saved_search:$(target).val()}});updateTotal()}))}updateTotal();break;case 3:showFrame();$(`#${elPrefix}-confirm`).on("click",(()=>{const{query:query={},total_contacts:total_contacts=0,when:when="now",date:date="",time:time="",send_in_local_time:send_in_local_time=false}=state;post(routes.v4.broadcasts,{object_id:state.email_id,object_type:"email",query:query,date:date,time:time,send_now:when==="now",send_in_local_time:send_in_local_time}).then((r=>r.item)).then((b=>{const scheduling=()=>`\n\t\t\t\t\t  <h2 id="broadcast-progress-header">${__("Scheduling","groundhogg")}</h2>\n\t\t\t\t\t  <div id="broadcast-progress"></div>`;$("#gh-send-broadcast-form").html(scheduling());const{stop:stopDots}=loadingDots("#broadcast-progress-header");const{setProgress:setProgress}=progressBar("#broadcast-progress");const schedule=()=>{post(`${routes.v4.broadcasts}/${b.ID}/schedule`).then((({finished:finished,scheduled:scheduled})=>{setProgress(scheduled/total_contacts);if(!finished){schedule()}else{setTimeout((()=>{stopDots();dialog({message:__("Broadcast scheduled!","groundhogg")});onScheduled()}),500)}})).catch((()=>{errorDialog({message:__("Something went wrong...","groundhogg")})}))};schedule()})).catch((()=>{errorDialog({message:__("Something went wrong...","groundhogg")});setStep(3)}))}));break}$(".gh-next-step").on("click",nextStep)}})};Groundhogg.SendBroadcast=SendBroadcast;$((()=>{$("#gh-schedule-broadcast").on("click",(e=>{e.preventDefault();const{close:close}=modal({dialogClasses:"overflow-visible",content:`<div id="gh-broadcast-form" style="width: 400px"></div>`});SendBroadcast("#gh-broadcast-form",{},{onScheduled:()=>{window.location.href=adminPageURL("gh_broadcasts",{status:"scheduled"})}})}));if(typeof GroundhoggNewBroadcast!=="undefined"){SendBroadcast("#gh-broadcast-form-inline",{email:GroundhoggNewBroadcast.email},{onScheduled:()=>{window.location.href=adminPageURL("gh_broadcasts",{status:"scheduled"})}})}}))})(jQuery);