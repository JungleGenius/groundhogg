(function($){const{copyObject:copyObject,select:select,input:input,tinymceElement:tinymceElement,specialChars:specialChars,breadcrumbs:breadcrumbs,improveTinyMCE:improveTinyMCE,inputWithReplacementsAndEmojis:inputWithReplacementsAndEmojis,inputWithReplacements:inputWithReplacements,inputRepeaterWidget:inputRepeaterWidget,textarea:textarea,isValidEmail:isValidEmail,adminPageURL:adminPageURL,modal:modal,dialog:dialog,loadingDots:loadingDots,moreMenu:moreMenu,objectEquals:objectEquals,toggle:toggle,icons:icons,codeEditor:codeEditor,confirmationModal:confirmationModal,savingModal:savingModal,dangerConfirmationModal:dangerConfirmationModal}=Groundhogg.element;const{post:post,get:get,patch:patch,delete:apiDelete,routes:routes}=Groundhogg.api;const{user_test_email:user_test_email}=Groundhogg;const{emails:EmailsStore,campaigns:CampaignsStore}=Groundhogg.stores;const{campaignPicker:campaignPicker}=Groundhogg.pickers;const{__:__,_x:_x,_n:_n,_nx:_nx,sprintf:sprintf}=wp.i18n;const setFrameContent=(frame,content)=>{var blob=new Blob([content],{type:"text/html; charset=utf-8"});frame.src=URL.createObjectURL(blob)};const EmailEditor=({selector:selector,email:email,onChange:onChange=(email=>{}),onCommit:onCommit=(email=>{}),breadcrumbs:crumbs=["Emails"],onHeaderMount:onHeaderMount=(()=>{}),afterPublishActions:afterPublishActions=""})=>({selector:selector,email:copyObject(email),origEmail:copyObject(email),$el:$(selector),undoStates:[],redoStates:[],edited:{data:{},meta:{}},components:{editor(){return`\n\t\t\t<div id="email-editor">\n\t\t\t\t<div id="email-editor-header">\n\t\t\t\t\t${this.components.header.call(this)}\n\t\t\t\t</div>\n\t\t\t\t<div id="email-editor-body">\n\t\t\t\t\t<div id="email-editor-main">\n\t\t\t\t\t\t<div id="email-editor-content">\n\t\t\t\t\t\t\t${this.components.content.call(this)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div id="email-editor-content-editor">\n\t\t\t\t\t\t\t${this.components.contentEditor.call(this)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div id="email-editor-advanced">\n\t\t\t\t\t\t\t${this.components.controls.call(this)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div id="email-editor-sidebar">\n\t\t\t\t\t\t${this.components.sidebar.call(this)}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n        `},header(){const titleEdit=()=>input({id:"email-title-edit",name:"email-title",value:this.email.data.title});const titleDisplay=()=>`<span id="email-title">${specialChars(this.email.data.title)}</span><span class="dashicons dashicons-edit"></span>`;return`\n\t\t\t<div class="title-wrap">\n\t\t\t\t<h1 class="breadcrumbs">${breadcrumbs([...crumbs,this.isEditingTitle?titleEdit():titleDisplay()])}</h1>\n\t\t\t</div>\n\t\t\t<div class="actions">\n\t\t\t\t<div class="undo-and-redo">\n\t\t\t\t\t<button class="redo dashicon-button" ${this.redoStates.length?"":"disabled"}><span\n\t\t\t\t\t\tclass="dashicons dashicons-redo"></span></button>\n\t\t\t\t\t<button class="undo dashicon-button" ${this.undoStates.length?"":"disabled"}><span\n\t\t\t\t\t\tclass="dashicons dashicons-undo"></span></button>\n\t\t\t\t</div>\n\t\t\t\t<div class="publish-actions">\n\t\t\t\t\t${this.email.data.status==="ready"?`<button id="to-draft" class="gh-button danger text">Back to draft</button>\n\t\t\t\t\t<button id="commit" class="gh-button primary" ${this.hasChanges()?"":"disabled"}>Update</button>`:`<button id="commit" class="gh-button action">Publish</button>`}\n\t\t\t\t</div>\n\t\t\t\t<button id="email-actions" class="gh-button secondary text icon">${icons.verticalDots}</button>\n\t\t\t\t${afterPublishActions}\n\t\t\t</div>\n        `},content(){const{subject:subject="",pre_header:pre_header=""}=this.edited.data;return`\n\t\t\t<div class="inline-label">\n\t\t\t\t<label for="subject">Subject:</label>\n\t\t\t\t${inputWithReplacementsAndEmojis({id:"subject",name:"subject",placeholder:"Subject line...",value:subject})}\n\t\t\t</div>\n\t\t\t<div class="inline-label">\n\t\t\t\t<label for="preview-text">Preview:</label>\n\t\t\t\t${inputWithReplacementsAndEmojis({id:"preview-text",name:"pre_header",placeholder:"Preview text...",value:pre_header})}\n\t\t\t</div>\n        `},contentEditor(){const{content:content=""}=this.edited.data;return`\n\t\t\t<div class="email-content-wrap">\n\t\t\t\t${textarea({id:"content",className:"wp-editor-area",value:this.edited.data.content})}\n\t\t\t</div>`},sidebar(){const message_typeOptions={marketing:"Marketing",transactional:"Transactional"};const{reply_to_override:reply_to_override="",alignment:alignment="left",from_user:from_user=0,message_type:message_type="marketing"}=this.edited.meta;return`\n\t\t\t<div class="gh-panel">\n\t\t\t\t<div class="inside">\n\t\t\t\t\t<div id="email-editor-sidebar-controls" class="gh-button-group">\n\t\t\t\t\t\t<button id="send-test" class="gh-button secondary">Send test email</button>\n\t\t\t\t\t\t<button data-device="mobile" class="show-preview gh-button secondary">\n\t\t\t\t\t\t\t${icons.smartphone}\n\t\t\t\t\t\t</button>\n\t\t\t\t\t\t<button data-device="desktop" class="show-preview gh-button secondary">\n\t\t\t\t\t\t\t${icons.desktop}\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t\t<p>\n\t\t\t\t\t\t<label class="">Send this email from:</label>\n\t\t\t\t\t\t${select({id:"from-user",name:"from_user"},Groundhogg.filters.owners.map((owner=>({text:owner.data.user_email,value:owner.ID}))),from_user)}\n\t\t\t\t\t</p>\n\t\t\t\t\t<p>\n\t\t\t\t\t\t<label class="">Replies are sent to:</label>\n\t\t\t\t\t\t${input({id:"reply-to",name:"reply_to_override",value:reply_to_override})}\n\t\t\t\t\t</p>\n\t\t\t\t\t<div id="email-editor-sidebar-options">\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<label class="">Alignment:</label>\n\t\t\t\t\t\t\t<button id="align-left" data-alignment="left"\n\t\t\t\t\t\t\t        class="change-alignment gh-button ${alignment==="left"?"primary":"secondary"}">\n\t\t\t\t\t\t\t\t${icons.alignLeft}\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t<button id="align-center" data-alignment="center"\n\t\t\t\t\t\t\t        class="change-alignment gh-button ${alignment==="center"?"primary":"secondary"}">\n\t\t\t\t\t\t\t\t${icons.alignCenter}\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div id="email-editor-sidebar-message_type">\n\t\t\t\t\t\t\t<label class="">Messaging type:</label>\n\t\t\t\t\t\t\t${select({id:"message-type",name:"message_type"},message_typeOptions,message_type)}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n        `},controls(){return`\n\t\t\t<h3>Custom email headers</h3>\n\t\t\t<div id="email-editor-advanced-headers">\n\t\t\t</div>\n        `},inspector(){}},autoSaveTimeout:null,abortController:null,autoSaveChanges(){this.saveUndoState();if(this.autoSaveTimeout){clearTimeout(this.autoSaveTimeout)}this.autoSaveTimeout=setTimeout((()=>{this.autoSaveTimeout=null;this.abortController=new AbortController;const{signal:signal}=this.abortController;EmailsStore.patch(this.email.ID,{meta:{edited:this.edited}},{signal:signal}).then((e=>{this.loadEmail(e);this.abortController=null}))}),3e3)},hasChanges(){return!objectEquals(this.email.data,this.edited.data)},update(data){return EmailsStore.patch(this.email.ID,data).then((e=>{this.loadEmail(e);return e})).catch((e=>{dialog({type:"error",message:__("Something went wrong","groundhogg")})}))},commitChanges(){if(this.autoSaveTimeout){clearTimeout(this.autoSaveTimeout)}else if(this.abortController){this.abortController.abort()}const{close:close}=savingModal();return EmailsStore.patch(this.email.ID,{data:{...this.edited.data,status:"ready",title:this.email.data.title},meta:{...this.edited.meta,edited:{...this.edited}}}).then((e=>{this.loadEmail(e);this.mount();onCommit(e);close()})).catch((e=>{dialog({type:"error",message:__("Something went wrong","groundhogg")})}))},updateEmailData(newData){this.edited.data={...this.edited.data,...newData};this.autoSaveChanges()},updateEmailMeta(newMeta){this.edited.meta={...this.edited.meta,...newMeta};this.autoSaveChanges();onChange(this.edited,this.email)},render(){return this.components.editor.call(this)},mount(){improveTinyMCE();if(this.mounted){this.demount()}this.mounted=true;this.loadEmail(this.email);this.$el.html(this.render());this.onMount()},loadEmail(email){this.email=copyObject(email);if(email.meta.edited){this.edited=copyObject(email.meta.edited)}else{this.edited=copyObject(email)}},onMount(){let saveTimer;const handleContentOnChange=content=>{clearTimeout(saveTimer);saveTimer=setTimeout((()=>{this.updateEmailData({content:content});mountHeader()}),150)};const mainContentMount=()=>{if(this.edited.meta.type==="html"){const{editor:editor}=codeEditor({selector:"#content",onChange:handleContentOnChange,initialContent:this.edited.data.content});this.codemirror=editor}else{tinymceElement("content",{tinymce:true,quicktags:true},handleContentOnChange)}$("#subject, #preview-text").on("change",(e=>{this.updateEmailData({[e.target.name]:e.target.value});mountHeader()}));const getHeadersArray=()=>{const{custom_headers:custom_headers={}}=this.edited.meta;const rows=[];Object.keys(custom_headers).forEach((key=>{rows.push([key,custom_headers[key]])}));if(!rows.length){rows.push(["",""])}return rows};const headersEditor=inputRepeaterWidget({selector:"#email-editor-advanced-headers",rows:getHeadersArray(),cellProps:[{placeholder:"Header..."},{placeholder:"Value..."}],cellCallbacks:[input,inputWithReplacements],onChange:rows=>{const headers={};rows.forEach((([key,value])=>{headers[key]=value}));this.updateEmailMeta({custom_headers:headers});mountHeader()}});headersEditor.mount()};const mountHeader=()=>{$("#email-editor-header").html(this.components.header.call(this));headerMounted()};const headerMounted=()=>{const handleOnSelect=key=>{switch(key){case"campaigns":const campaignContent=()=>`\n\t\t\t\t\t<div class="manage-campaigns" style="width: 400px">\n\t\t\t\t\t\t<h2>${__("Add this email to one or more campaigns...","groundhogg")}</h2>\n\t\t\t\t\t\t<p>${select({id:"manage-campaigns",multiple:true})}</p>\n\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\t${__("Campaigns are a tool to group marketing assets for reporting. Visit the dashboard to see an analytics breakdown by campaign.","groundhogg")}</p>\n\t\t\t\t\t</div>`;modal({content:campaignContent()});campaignPicker("#manage-campaigns",true,(items=>{CampaignsStore.itemsFetched(items)}),{placeholder:__("Select one or more campaigns","groundhogg"),width:"100%",data:[{id:"",text:""},...this.email.campaigns.map((c=>({...c,id:c.ID,text:c.data.name,selected:true})))]}).on("select2:select",(async e=>{let campaign=e.params.data;if(!CampaignsStore.hasItem(campaign.id)){campaign=await CampaignsStore.post({data:{name:campaign.id}}).then((c=>({id:c.ID,name:c.data.name})))}post(`${routes.v4.emails}/${this.email.ID}/relationships`,{other_id:campaign.id,other_type:"campaign"}).then((r=>this.loadEmail(r.item)))})).on("select2:unselect",(async e=>{let campaign=e.params.data;apiDelete(`${routes.v4.emails}/${this.email.ID}/relationships`,{other_id:campaign.id,other_type:"campaign"}).then((r=>this.loadEmail(r.item)))}));break;case"export":window.location.href=this.email.links.export;break;case"share":const sharingModalOnMount=()=>{$("#sharing-enabled").on("change",(({target:target})=>{this.update({meta:{sharing:target.checked?"enabled":"disabled"}}).then((()=>{setShareContent(sharingModalContent());sharingModalOnMount()}))}))};const sharingModalContent=()=>{if(this.email.meta.sharing!=="enabled"){return`\n\t\t\t\t\t  <div class="share">\n\t\t\t\t\t\t  <h2>${__("Sharing is not enabled","groundhogg")}</h2>\n\t\t\t\t\t\t  <p>${__("Enable sharing?","groundhogg")} ${toggle({name:"sharing",id:"sharing-enabled",checked:this.email.meta.sharing==="enabled",onLabel:_x("YES","toggle switch","groundhogg"),offLabel:_x("NO","toggle switch","groundhogg")})}</p>\n\t\t\t\t\t\t  <p>\n\t\t\t\t\t\t\t  ${__("When sharing is enabled this email can be downloaded via a private link.","groundhogg")}</p>\n\t\t\t\t\t  </div>`}else{return`\n\t\t\t\t\t  <div class="share">\n\t\t\t\t\t\t  <h2>${__("Share this email","groundhogg")}</h2>\n\t\t\t\t\t\t  ${input({type:"url",className:"code full-width",readonly:true,value:this.email.links.export,onfocus:"this.select()"})}\n\t\t\t\t\t\t  <p>\n\t\t\t\t\t\t\t  ${__("Anyone with the above link will be able to download a copy of this email.","groundhogg")}</p>\n\t\t\t\t\t\t  <p>${__("Enable sharing?","groundhogg")} ${toggle({name:"sharing",id:"sharing-enabled",checked:this.email.meta.sharing==="enabled",onLabel:_x("YES","toggle switch","groundhogg"),offLabel:_x("NO","toggle switch","groundhogg")})}</p>\n\t\t\t\t\t  </div>`}};const{setContent:setShareContent}=modal({content:sharingModalContent()});sharingModalOnMount();break;case"reports":window.location.href=this.email.links.report;break;case"delete":dangerConfirmationModal({alert:`<p><b>${__("Delete this email?","groundhogg")}</b></p>\n\t\t\t\t<p>${__("Any associated events and reports will also be deleted.","groundhogg")}</p>\n\t\t\t\t<p>${__("This action cannot be undone. Are you sure?","groundhogg")}</p>`,confirmText:__("Delete"),onConfirm:()=>{EmailsStore.delete(this.email.ID).then((()=>{dialog({message:__("Email deleted!","groundhogg")});window.location.href=adminPageURL("gh_emails")}))}});break;case"archive":dangerConfirmationModal({alert:`\n\t\t\t\t\t<p>\n\t\t\t\t\t\t<b>${_x("Archive this funnel?","archive is representing a verb in this phrase","groundhogg")}</b>\n\t\t\t\t\t</p>\n\t\t\t\t\t<p>\n\t\t\t\t\t\t${__("Any active contacts will be removed from the funnel permanently. The funnel will become un-editable until restored.","groundhogg")}</p>`,confirmText:_x("Archive","a verb meaning to add an item to an archive","groundhogg"),onConfirm:()=>{this.update({data:{status:"archived"}}).then((()=>{dialog({message:__("Funnel Archived","groundhogg")});window.location.href=adminPageURL("gh_funnels")}))}});break;case"send":if(this.email.data.status!=="ready"){confirmationModal({alert:`<p>${__("Before this email can be sent it must be published. Would you like to publish it now?","groundhogg")}<p>`,confirmText:__("Publish"),onConfirm:()=>{this.commitChanges().then((()=>{handleOnSelect("send")}))}});break}const{close:close}=modal({content:`<div id="gh-broadcast-form" style="width: 400px"></div>`});Groundhogg.SendBroadcast("#gh-broadcast-form",{email:this.email},{onScheduled:()=>{dialog({message:__("Broadcast scheduled")});close()}});break}};$("#email-actions").on("click",(e=>{moreMenu(e.currentTarget,{onSelect:handleOnSelect,items:[{key:"campaigns",text:`${icons.campaign} ${_x("Campaigns","noun meaning collection of marketing materials","groundhogg")}`},{key:"export",text:`${icons.export} ${_x("Export","a verb meaning to download","groundhogg")}`},{key:"share",text:`${icons.share} ${_x("Share","a verb meaning to share something","groundhogg")}`},{key:"reports",text:`${icons.chart} ${__("Reports","groundhogg")}`},{key:"send",text:`${icons.megaphone} ${__("Send Broadcast","groundhogg")}`},{key:"archive",text:`${icons.folder} <span\n\t\t\t\t\tclass="gh-text danger">${_x("Archive","a verb meaning to add an item to an archive","groundhogg")}</span>`},{key:"delete",text:`${icons.trash} <span class="gh-text danger">${__("Delete")}</span>`}]})}));$("#commit").on("click",(()=>{this.commitChanges()}));$("#to-draft").on("click",(()=>{dangerConfirmationModal({alert:`<p>${__("Once in draft mode this email cannot be sent. Are you sure?","groundhogg")}</p>`,confirmText:__("Unpublish"),onConfirm:()=>{const{close:close}=savingModal();EmailsStore.patch(this.email.ID,{data:{status:"draft"}}).then((e=>{this.loadEmail(e);close();mountHeader()}))}})}));$(".undo-and-redo .undo").on("click",(e=>{this.undo();$(".undo-and-redo .undo").focus()}));$(".undo-and-redo .redo").on("click",(e=>{this.redo();$(".undo-and-redo .redo").focus()}));if(!this.isEditingTitle){$("#email-title").on("click",(e=>{this.isEditingTitle=true;mountHeader()}))}else{$("#email-title-edit").focus().on("change blur keydown",(e=>{if(e.type==="keydown"&&e.key!=="Enter"){return}const title=e.target.value;this.email.data.title=title;this.isEditingTitle=false;mountHeader();EmailsStore.patch(this.email.ID,{data:{title:title}}).then((e=>{this.loadEmail(e)}))}))}onHeaderMount()};const mountSidebar=()=>{$("#email-editor-sidebar").html(this.components.sidebar.call(this));sidebarMount()};const sidebarMount=()=>{$(".show-preview").on("click",(e=>{const device=e.currentTarget.dataset.device;modal({content:`<iframe id="preview" class="${device}"></div>`});const{built:built,edited_preview:edited_preview}=this.email.context;setFrameContent($("#preview")[0],edited_preview||built)}));$("#from-user").select2().on("change",(e=>{this.updateEmailData({from_user:e.target.value});mountHeader()}));$("#message-type").on("change",(e=>{this.updateEmailMeta({message_type:e.target.value});mountHeader()}));$("#reply-to").autocomplete({change:e=>{this.updateEmailMeta({reply_to_override:e.target.value});mountHeader()},source:["{owner_email}",...Groundhogg.filters.owners.map((u=>u.data.user_email))]});$(".change-alignment").on("click",(e=>{this.updateEmailMeta({alignment:e.currentTarget.dataset.alignment});mountHeader();mountSidebar();$("#"+e.currentTarget.id).focus()}));$("#send-test").on("click",(e=>{if(!this.testEmailAddress){this.testEmailAddress=user_test_email}const modalContent=(isSending=false)=>`<h2>Send a test email to the following address...</h2>\n\t\t\t<div class="test-email-address-wrap">\n\t\t\t\t${input({type:"email",id:"email-address",name:"email-address",placeholder:"Your email...",disabled:isSending,value:this.testEmailAddress})}\n\t\t\t\t<button id="initiate-test" class="gh-button primary" ${isSending?"disabled":""}>\n\t\t\t\t\t<span>${isSending?"Sending":"Send"}</span>\n\t\t\t\t</button>\n\t\t\t</div>`;const{$modal:$modal,close:closeModal,setContent:setContent}=modal({content:modalContent()});$("#email-address").autocomplete({source:Groundhogg.filters.owners.map((u=>u.data.user_email)),change:e=>{this.testEmailAddress=e.target.value;mountHeader()}});$("#initiate-test").on("click",(()=>{setContent(modalContent(true));const{stop:stopDots}=loadingDots("#initiate-test");post(`${routes.v4.emails}/${this.email.ID}/test`,{to:this.testEmailAddress,edited:this.edited}).then((r=>{stopDots();setContent(`<p>Test sent to <b>${this.testEmailAddress}</b></p>`);setTimeout(closeModal,2e3)}))}))}))};mainContentMount();sidebarMount();headerMounted()},demount(){this.onDemount()},onDemount(){if(this.edited.meta.type==="html"){this.codemirror.toTextArea()}else{wp.editor.remove("content")}},currentState(){const{email:email,edited:edited}=this;return{email:copyObject(email),edited:copyObject(edited)}},saveUndoState(){this.undoStates.push(this.currentState())},undo(){var lastState=this.undoStates.pop();if(!lastState){return}this.redoStates.push(this.currentState());Object.assign(this,lastState);this.mount()},redo(){var lastState=this.redoStates.pop();if(!lastState){return}this.undoStates.push(this.currentState());Object.assign(this,lastState);this.mount()}});Groundhogg.EmailEditor=EmailEditor})(jQuery);