!function($){$.fn.wpghToolBar=function(){return this.each(function(){var e=$(this);0===e.find("wpgh-toolbar").length&&e.prepend('<wpgh-toolbar class="action-icons"><div><span class="dashicons dashicons-admin-page"></span><span class="dashicons dashicons-move handle"></span><span class="dashicons dashicons-trash"></span></div></wpgh-toolbar>')}),this}}(jQuery),function($,e){$.extend(e,{editor:null,actions:null,settings:null,active:null,alignment:null,sidebar:null,htmlCode:null,sendTest:!1,init:function(){var e=this,t=$(document);e.editor=$("#email-body"),e.actions=$("#editor-panel"),e.settings=$("#settings-panel"),t.on("click","#enter-full-screen",function(e){$("html").toggleClass("full-screen")}),$("#update_and_test").click(function(t){e.sendTest=!0}),e.editor.on("click",function(t){t.preventDefault(),e.feed(t.target)}),e.editor.on("click","span.dashicons-admin-page",function(t){t.preventDefault(),e.duplicateBlock(t.target)}),e.editor.on("click","span.dashicons-trash",function(t){t.preventDefault(),e.deleteBlock(t.target),e.feed(null)}),$("#email-form").on("submit",function(t){t.preventDefault(),e.save($(this))}),$(".row").wpghToolBar(),e.alignment=$("#email-align"),e.alignment.on("change",function(){var e=$("#email-inside");"left"===$(this).val()?(e.css("margin-left","0"),e.css("margin-right","auto")):(e.css("margin-left","auto"),e.css("margin-right","auto"))}),e.inFrame()&&void 0!==parent.EmailStep&&($(document).on("change keydown keyup",function(e){parent.EmailStep.changesSaved=!1}),$(parent.document).on("click","#popup-close-footer",function(t){e.save($("#email-form"))}),parent.EmailStep.newEmailId=e.id),e.editorSizing(),$(window).resize(function(){e.editorSizing()}),$("#editor-toggle").change(function(t){$(this).is(":checked")?(e.htmlCode||e.initCodeMirror(),$("body").addClass("html-view"),$("#email-content").hide(),$("#html-editor").show(),e.prepareEmailHTML(),e.htmlCode.doc.setValue(html_beautify($("#email-inside").html(),{indent_with_tabs:!0}))):($("body").removeClass("html-view"),$(".row").wpghToolBar(),$("#html-editor").hide(),$("#email-content").show())}).change(),e.makeSortable(),e.makeDraggable(),e.makeResizable(),this.sidebar=new StickySidebar("#postbox-container-1",{topSpacing:e.inFrame()?47:78,bottomSpacing:0})},prepareEmailHTML:function(){var e=$("#email-content");$("wpgh-toolbar").remove(),e.find("div").removeAttr("contenteditable").removeClass("active")},initCodeMirror:function(){var e=this,t=wp.codeEditor.defaultSettings?_.clone(wp.codeEditor.defaultSettings):{};t.codemirror=_.extend({},t.codemirror,{indentUnit:4,tabSize:4}),e.htmlCode=wp.codeEditor.initialize($("#html-code"),t).codemirror,e.htmlCode.on("change",function(){$("#email-inside").html(e.htmlCode.doc.getValue())}),e.htmlCode.setSize(null,e.editor.height())},inFrame:function(){try{return window.self!==window.top}catch(e){return!0}},save:function(e){var t=this;showSpinner(),t.prepareEmailHTML(),$("#content").val($("#email-inside").html());var i=e.serialize();(i+="&action=gh_update_email",t.sendTest)&&(i=i+"&test_email="+prompt(t.send_test_prompt,t.test_email));adminAjaxRequest(i,function(e){handleNotices(e.data.notices),hideSpinner();var i=e.data.data.data.content,n=e.data.data.meta.alt_body;$("#email-inside").html(i),$("#alt-body-input").val(n),$(".row").wpghToolBar(),t.inFrame()&&void 0!==parent.EmailStep&&(parent.EmailStep.changesSaved=!0),$("#send-test").val(null),t.sendTest=!1})},editorSizing:function(){$("#email-body").css("min-height",$("#postbox-container-1").height())},makeSortable:function(){$(".email-sortable").sortable({placeholder:"sortable-placeholder",axis:"y",start:function(e,t){t.placeholder.height(t.item.height())},handle:".handle",stop:function(e,t){}})},makeDraggable:function(){$(".email-draggable").draggable({connectToSortable:".email-sortable",helper:"clone",start:function(e,t){var i=this.id.replace("-block",""),n=$("."+i+"-template").html();$("#temp-html").html(n)},stop:function(e,t){$("#email-content").find(".email-draggable").replaceWith($("#temp-html").html())}})},makeResizable:function(){var e=this,t=this.resizeListener={},i=$("#post-body"),n=$("#postbox-container-1"),a=$(".inner-wrapper-sticky");t.sidebarWidth=n.width(),i.resizable({handles:"w",resize:function(e,o){t.change=o.position.left-o.originalPosition.left,n.width(t.sidebarWidth+t.change),a.width(t.sidebarWidth+t.change),i.css("margin-left",t.sidebarWidth+t.change+1+"px"),n.css("margin-left",-(t.sidebarWidth+t.change+1)+"px"),i.css("left",0)},stop:function(i,a){t.sidebarWidth=n.width(),e.sidebar.updateSticky()},start:function(e,i){t.sidebarWidth=n.width()},grid:10})},makeClickable:function(){$(".email-draggable").on("dblclick",function(e){$("#email-content")})},hideBlockSettings:function(){this.editor.find(".row").removeClass("active"),this.actions.find(".postbox").addClass("hidden"),this.settings.show(),$(document).trigger("madeInactive"),this.sidebar.updateSticky()},feed:function(e){if(e){if(null!==e.parentNode){var t=$(e).closest(".row");if(!t.hasClass("active"))if(t.hasClass("row")){this.active=t,this.editor.find(".row").removeClass("active"),t.addClass("active");var i=t.attr("data-block");if(void 0===i&&void 0!==t){var n=t.find(".content-wrapper").attr("class");i=(i=/\w+_block/.exec(n)[0]).replace("_block","")}this.actions.find(".postbox").addClass("hidden"),this.actions.find("#"+i+"-block-editor").removeClass("hidden"),this.settings.hide(),$(document).trigger("madeActive",[t,i]),this.sidebar.updateSticky()}else this.hideBlockSettings()}}else this.hideBlockSettings()},deleteBlock:function(e){$(e).closest(".row").remove()},duplicateBlock:function(e){$(document).trigger("duplicateBlock"),$(e).closest(".row").removeClass("active"),$(e).closest(".row").clone().insertAfter($(e).closest(".row"))},getActive:function(){return this.active}}),$(function(){e.init()});var t=!1;$(function(){var e=$("#post-body"),i=$("#postbox-container-1"),n=$("#post-body-content");$("#drag").on("mousedown",function(e){t=!0,e.clientX}),$(document).on("mousemove",function(a){if(t){var o=e.width()-(a.clientX-e.offset().left);i.css("right",o),n.css("width",o)}}).on("mouseup",function(e){t=!1})})}(jQuery,EmailEditor);