(function($,nonces,endpoints,gh){const{currentUser:currentUser,isSuperAdmin:isSuperAdmin}=Groundhogg;Groundhogg.user={getCurrentUser:()=>{return currentUser},userHasCap:cap=>{return currentUser.allcaps[cap]||currentUser.caps[cap]||isSuperAdmin}};$.fn.serializeFormJSON=function(){var o={};var a=this.serializeArray();$.each(a,function(){if(o[this.name]){if(!o[this.name].push){o[this.name]=[o[this.name]]}o[this.name].push(this.value||"")}else{o[this.name]=this.value||""}});return o};function picker(selector,args){return $(selector).select2(args)}$.fn.ghPicker=function({endpoint:endpoint,getResults:getResults=r=>r.items,getParams:getParams=q=>({...q,search:q.term}),...rest}){this.select2({tokenSeparators:["/",",",";"],delay:100,ajax:{url:endpoint,dataType:"json",data:getParams,beforeSend:function(xhr){xhr.setRequestHeader("X-WP-Nonce",nonces._wprest)},processResults:function(data,page){return{results:getResults(data,page)}}},...rest});return this};function apiPicker(selector,endpoint,multiple=false,tags=false,getResults=d=>d.results,getParams=q=>({...q,search:q.term}),select2opts={}){return $(selector).select2({tags:tags,multiple:multiple,tokenSeparators:["/",",",";"],delay:100,ajax:{url:endpoint,dataType:"json",data:getParams,beforeSend:function(xhr){xhr.setRequestHeader("X-WP-Nonce",nonces._wprest)},processResults:function(data,page){return{results:getResults(data,page)}}},...select2opts})}function linkPicker(selector){return $(selector).autocomplete({source:function(request,response){$.ajax({url:ajaxurl,method:"post",dataType:"json",data:{action:"wp-link-ajax",_ajax_linking_nonce:nonces._ajax_linking_nonce,term:request.term},success:function(data){var $return=[];for(var item in data){if(data.hasOwnProperty(item)){item=data[item];$return.push({label:item.title+" ("+item.info+")",value:item.permalink})}}response($return)}})},minLength:0})}function userMetaPicker(selector){return $(selector).autocomplete({source:function(request,response){$.ajax({url:ajaxurl,method:"post",dataType:"json",data:{action:"user_meta_picker",nonce:nonces._meta_nonce,term:request.term},success:function(data){response(data);$(selector).removeClass("ui-autocomplete-loading")}})},minLength:0})}function metaPicker(selector){return $(selector).autocomplete({source:function(request,response){$.ajax({url:ajaxurl,method:"post",dataType:"json",data:{action:"gh_meta_picker",nonce:nonces._meta_nonce,term:request.term},success:function(data){response(data);$(selector).removeClass("ui-autocomplete-loading")}})},minLength:0})}function metaValuePicker(selector,meta_key){return $(selector).autocomplete({source:function(request,response){$.ajax({url:ajaxurl,method:"post",dataType:"json",data:{action:"gh_meta_value_picker",nonce:nonces._meta_nonce,term:request.term,meta_key:meta_key},success:function(data){response(data);$(selector).removeClass("ui-autocomplete-loading")}})},minLength:0})}function tagPicker(selector,multiple=true,onReceiveItems=items=>{},...opts){return apiPicker(selector,gh.api.routes.v4.tags,multiple,Groundhogg.user.userHasCap("add_tags"),data=>{onReceiveItems(data.items);return data.items.map(item=>({id:item.ID,text:`${item.data.tag_name}`}))},query=>{return{search:query.term,limit:50}},...opts)}function contactPicker(selector,onReceiveItems=items=>{},...opts){return apiPicker(selector,gh.api.routes.v4.contacts,false,false,data=>{onReceiveItems(data.items);return data.items.map(item=>({id:item.ID,text:`${item.data.first_name} ${item.data.last_name} (${item.data.email})`}))},query=>{return{search:query.term,limit:50}},...opts)}function campaignPicker(selector,multiple=true,onReceiveItems=items=>{},...opts){return apiPicker(selector,gh.api.routes.v4.campaigns,multiple,true,data=>{onReceiveItems(data.items);return data.items.map(item=>({id:item.ID,text:`${item.data.name}`}))},query=>{return{search:query.term}},...opts)}function emailPicker(selector,multiple=false,onReceiveItems=items=>{},queryOpts={},...opts){return apiPicker(selector,gh.api.routes.v4.emails,multiple,false,data=>{onReceiveItems(data.items);return data.items.map(item=>({id:item.ID,text:`${item.data.title} (${item.data.status})`}))},query=>{return{search:query.term,...queryOpts}},...opts)}function funnelPicker(selector,multiple=false,onReceiveItems=items=>{},queryOpts={},...opts){return apiPicker(selector,gh.api.routes.v4.funnels,multiple,false,data=>{onReceiveItems(data.items);return data.items.map(item=>({id:item.ID,text:`${item.data.title}`}))},query=>{return{search:query.term,...queryOpts}},...opts)}function broadcastPicker(selector,multiple=false,onReceiveItems=items=>{},queryOpts={},...opts){return apiPicker(selector,gh.api.routes.v4.broadcasts,multiple,false,data=>{onReceiveItems(data.items);return data.items.map(item=>({id:item.ID,text:`${item.object.data.title} (${item.date_sent_pretty})`}))},query=>{return{search:query.term,...queryOpts}},...opts)}function searchesPicker(selector,onReceiveItems=items=>{},queryOpts={},...opts){return apiPicker(selector,gh.api.routes.v4.searches,false,false,data=>{onReceiveItems(data.items);return data.items.map(item=>({id:item.id,text:item.name}))},query=>{return{search:query.term,...queryOpts}},...opts)}function buildPickers(){picker(".gh-select2",{});tagPicker(".gh-tag-picker",true);tagPicker(".gh-single-tag-picker",false);emailPicker(".gh-email-picker",false);emailPicker(".gh-email-picker-multiple",true);apiPicker(".gh-sms-picker",endpoints.sms,false,false);contactPicker(".gh-contact-picker");contactPicker(".gh-contact-picker-multiple",items=>{},{multiple:true});apiPicker(".gh-benchmark-picker",endpoints.benchmarks,false,false);apiPicker(".gh-metakey-picker",endpoints.metakeys,false,false);linkPicker(".gh-link-picker");metaPicker(".gh-meta-picker")}$(function(){buildPickers()});$(document).on("new-step gh-init-pickers",function(){buildPickers()});$(document).on("click",".dropdown-button .button.dropdown",function(){var $button=$(this);$button.next().toggleClass("show");$("<div class='dropdown-overlay'></div>").insertAfter($button)});$(document).on("click",".dropdown-button .dropdown-overlay",function(){var $overlay=$(this);$overlay.next().toggleClass("show");$overlay.remove()});gh.pickers={picker:picker,tagPicker:tagPicker,emailPicker:emailPicker,apiPicker:apiPicker,linkPicker:linkPicker,metaPicker:metaPicker,userMetaPicker:userMetaPicker,campaignPicker:campaignPicker,searchesPicker:searchesPicker,funnelPicker:funnelPicker,broadcastPicker:broadcastPicker,metaValuePicker:metaValuePicker,contactPicker:contactPicker};gh.nonces=nonces;gh.endpoints=endpoints;if(!gh.functions){gh.functions={}}gh.functions.setCookie=(cname,cvalue,duration)=>{var d=new Date;d.setTime(d.getTime()+duration*1e3);var expires="expires="+d.toUTCString();document.cookie=cname+"="+cvalue+";"+expires+";path=/"};gh.functions.getCookie=(cname,none=null)=>{var name=cname+"=";var ca=document.cookie.split(";");for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==" "){c=c.substring(1)}if(c.indexOf(name)==0){return c.substring(name.length,c.length)}}return none}})(jQuery,groundhogg_nonces,groundhogg_endpoints,Groundhogg);