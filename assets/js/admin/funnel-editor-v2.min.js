!function($,e,t,n){$.extend(e,{sortables:null,reportData:null,getSteps:function(){return $("#postbox-container-1")},getSettings:function(){return $(".step-settings")},init:function(){var e=this,t=$(document),n=$("#funnel-form"),a=e.getSteps();e.getSettings();t.on("change input",".step-title-large",function(){var e=$(this),t=e.attr("data-id");$("#"+t).find(".step-title").text(e.val())}),t.on("click","#postbox-container-1 .step",function(t){e.makeActive(this.id)}),t.on("click","td.step-icon",function(t){var n=a.find(".active");$('<div class="replace-me"></div>').insertAfter(n);var i=$(this).find(".wpgh-element").attr("id"),s=(a.index(n),{action:"wpgh_get_step_html",step_type:i,after_step:n.attr("id"),funnel_id:e.id,version:2});e.getStepHtml(s)}),t.on("click","button.delete-step",function(t){e.deleteStep(this.parentNode.parentNode.id)}),t.on("click","button.duplicate-step",function(t){e.duplicateStep(this.parentNode.parentNode.id)}),n.on("submit",function(t){t.preventDefault(),e.save(n)}),t.on("change",".auto-save",function(t){t.preventDefault(),e.save($("#funnel-form"))}),t.on("click","#enter-full-screen",function(e){$("html").toggleClass("full-screen")}),window.innerWidth>600&&this.makeSortable(),this.initReporting(),$("#add-contacts-button").click(function(){e.addContacts()}),$("#copy-share-link").click(function(e){e.preventDefault(),prompt("Copy this link.",$("#share-link").val())})},initReporting:function(){var e=$("#reporting-toggle");e.on("input",function(){$(this).is(":checked")?($(".step-reporting").removeClass("hidden"),$(".step-edit").addClass("hidden")):($(".step-reporting").addClass("hidden"),$(".step-edit").removeClass("hidden"))}),e.is(":checked")&&($(".step-reporting").removeClass("hidden"),$(".step-reporting").removeClass("hidden"),$(".step-edit").addClass("hidden")),$("#custom_date_range_start").datepicker({changeMonth:!0,changeYear:!0,maxDate:0,dateFormat:"d-m-yy"}),$("#custom_date_range_end").datepicker({changeMonth:!0,changeYear:!0,maxDate:0,dateFormat:"d-m-yy"}),$("#date_range").change(function(){"custom"===$(this).val()?($("#custom_date_range_end").removeClass("hidden"),$("#custom_date_range_start").removeClass("hidden")):($("#custom_date_range_end").addClass("hidden"),$("#custom_date_range_start").addClass("hidden"))})},save:function(e){var t=this;showSpinner();var a=e.serialize();a+="&action=gh_save_funnel_via_ajax&version=2",adminAjaxRequest(a,function(e){handleNotices(e.data.notices),hideSpinner(),t.getSettings().html(e.data.data.settings),t.getSteps().html(e.data.data.sortable),console.log(e),n.data=e.data.data.chartData,$("#funnel-chart").hasClass("hidden")||n.draw(),$(document).trigger("new-step")})},makeSortable:function(){this.sortables=$(".ui-sortable").sortable({placeholder:"sortable-placeholder",connectWith:".ui-sortable",axis:"y",start:function(e,t){t.helper.css("left",(t.item.parent().width()-t.item.width())/2),t.placeholder.height(t.item.height()),t.placeholder.width(t.item.width())}}),this.sortables.disableSelection()},deleteStep:function(e){showSpinner();var t=$("#"+e);confirm("Are you sure you want to delete this step? Any contacts currently waiting will be moved to the next action.")?adminAjaxRequest({action:"wpgh_delete_funnel_step",step_id:e},function(n){hideSpinner(),t.remove(),$("#settings-"+e).remove()}):hideSpinner()},duplicateStep:function(e){var t=$("#"+e);$('<div class="replace-me"></div>').insertAfter(t);var n={action:"wpgh_duplicate_funnel_step",step_id:e,version:2};this.getStepHtml(n)},getStepHtml:function(e){var n=this,a=n.getSteps(),i=n.getSettings();showSpinner(),adminAjaxRequest(e,function(e){a.find(".replace-me").replaceWith(e.data.data.sortable),i.append(e.data.data.settings),n.makeActive(e.data.data.id),t.close(),hideSpinner(),$(document).trigger("new-step")})},makeActive:function(e){var t=this.getSteps(),n=this.getSettings();n.find(".step").addClass("hidden"),n.find(".step").removeClass("active"),t.find(".step").removeClass("active"),t.find(".is_active").val(null);var a=$("#"+e);a.addClass("active"),a.find(".is_active").val(1);var i="#settings-"+a.attr("id"),s=$(i);s.removeClass("hidden"),s.addClass("active")}}),$(function(){e.init()})}(jQuery,Funnel,GroundhoggModal,FunnelChart);