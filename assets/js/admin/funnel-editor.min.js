var wpghFunnelEditor,wpghDoingAutoSave=!1;!function($){wpghFunnelEditor={editorID:"#normal-sortables",editor:null,sortables:null,draggables:null,curStep:null,curHTML:null,curOrder:0,reportData:null,init:function(){this.editor=$(this.editorID),this.editor.on("click","button.delete-step",function(e){wpghFunnelEditor.deleteStep(this)}),this.editor.on("click","button.duplicate-step",function(e){wpghFunnelEditor.duplicateStep(this)}),$("form").on("submit",function(e){e.preventDefault(),wpghFunnelEditor.save()}),$(document).on("wpghModalClosed",function(e){e.preventDefault(),wpghFunnelEditor.save()}),window.innerWidth>600&&(this.makeSortable(),this.makeDraggable()),this.initReporting(),this.editorSizing(),$(window).resize(function(){wpghFunnelEditor.editorSizing()}),$("#add-contacts-button").click(function(){wpghFunnelEditor.addContacts()}),$("#copy-share-link").click(function(e){e.preventDefault(),prompt("Copy This Link",$("#share-link").val())}),$(document).on("click",".postbox .collapse",function(e){var t=$(this.parentNode);t.hasClass("closed")?wpghFunnelEditor.expandStep(t):wpghFunnelEditor.collapseStep(t)})},editorSizing:function(){$(".funnel-editor-header").width($("#poststuff").width()),$("#postbox-container-2").height($("#wpbody").height()-80),$("#normal-sortables").css("visibility","visible"),$("#postbox-container-1").stickySidebar({topSpacing:78})},initReporting:function(){var e=$("#reporting-toggle");e.on("input",function(){$(this).is(":checked")?($(".step-reporting").removeClass("hidden"),$(".step-edit").addClass("hidden")):($(".step-reporting").addClass("hidden"),$(".step-edit").removeClass("hidden"))}),e.is(":checked")&&($(".step-reporting").removeClass("hidden"),$(".step-edit").addClass("hidden")),$("#custom_date_range_start").datepicker({changeMonth:!0,changeYear:!0,maxDate:0,dateFormat:"d-m-yy"}),$("#custom_date_range_end").datepicker({changeMonth:!0,changeYear:!0,maxDate:0,dateFormat:"d-m-yy"}),$("#date_range").change(function(){"custom"===$(this).val()?($("#custom_date_range_end").removeClass("hidden"),$("#custom_date_range_start").removeClass("hidden")):($("#custom_date_range_end").addClass("hidden"),$("#custom_date_range_start").addClass("hidden"))})},save:function(){$(".spinner").css("visibility","visible");var e=$("form").serialize();e+="&action=gh_save_funnel_via_ajax";$.ajax({type:"post",url:ajaxurl,dataType:"json",data:e,success:function(e){$("#notices").html(e.notices),$("#normal-sortables").html(e.steps),$("#confirm").fadeOut(300),$(".spinner").css("visibility","hidden"),wpghFunnelEditor.makeDismissible(),$(document).trigger("wpghAddedStep"),funnelChart.data=e.chartData,$("#funnel-chart").hasClass("hidden")||funnelChart.draw()}})},makeDismissible:function(){$("<button type='button' class='notice-dismiss'><span class='screen-reader-text'>Dismiss This Notice</span></button>").appendTo(".is-dismissible"),$(".notice-dismiss").on("click",function(e){$(this).parent().fadeOut(500,function(){$(this).remove()})})},insertDummyStep:function(e){return this.editor.find(e).length>0&&(this.editor.find(e).replaceWith('<div id="temp-step" class="postbox step replace-me" style="width: 500px;margin-right: auto;margin-left: auto;"><h3 class="hndle">Please Wait...</h3><div class="inside">Loading content...</div></div>'),!0)},replaceDummyStep:function(e){this.editor.find(".replace-me").replaceWith(e),$(document).trigger("wpghAddedStep")},convertDraggableToStep:function(e){var t=e.id;if(this.insertDummyStep(".ui-draggable")){var i={action:"wpgh_get_step_html",step_type:t,step_order:$(".step").index($("#temp-step"))+1};this.getStepHtml(i)}},makeDraggable:function(){this.draggables=$(".ui-draggable").draggable({connectToSortable:".ui-sortable",helper:"clone",stop:function(e,t){t.helper.closest("#normal-sortables").length>0&&(console.log(t.helper.parent()),wpghFunnelEditor.convertDraggableToStep(this))}})},makeSortable:function(){this.sortables=$(".ui-sortable").sortable({placeholder:"sortable-placeholder",connectWith:".ui-sortable",axis:"y",start:function(e,t){t.helper.css("left",(t.item.parent().width()-t.item.width())/2),t.placeholder.height(t.item.height()),t.placeholder.width(t.item.width())}}),this.sortables.disableSelection()},deleteStep:function(e){var t=$(e).closest(".step");if(confirm("Are you sure you want to delete this step? Any contacts currently waiting will be moved to the next action."))$.ajax({type:"post",url:ajaxurl,data:{action:"wpgh_delete_funnel_step",step_id:t.attr("id")},success:function(e){t.remove()}})},duplicateStep:function(e){var t=$(e).closest(".step");$('<div class="replace-me"></div>').insertAfter(t),this.insertDummyStep(".replace-me");var i={action:"wpgh_duplicate_funnel_step",step_id:t.attr("id")};this.getStepHtml(i)},getStepHtml:function(e){$.ajax({type:"post",url:ajaxurl,data:e,success:function(e){wpghFunnelEditor.curHTML=e,wpghFunnelEditor.replaceDummyStep(e)}})},addContacts:function(){var e=$("#add_contacts_to_funnel_tag_picker").val();if(e){var t=$("#add_contacts_to_funnel_step_picker").val();if(t){$(".spinner").css("visibility","visible");$.ajax({type:"post",url:ajaxurl,data:{action:"gh_add_contacts_to_funnel",tags:e,step:t},success:function(e){$(".spinner").css("visibility","hidden"),$(".add-contacts-response").html(e),$(".add-contacts-response").removeClass("hidden"),wpghFunnelEditor.makeDismissible()}})}else alert("Please select at funnel step.")}else alert("Please select at least 1 tag.")},collapseStep:function(e){console.log(e),e.addClass("closed"),e.find(".collapse-input").val("1")},expandStep:function(e){e.removeClass("closed"),e.find(".collapse-input").val("")}},$(function(){wpghFunnelEditor.init()})}(jQuery);