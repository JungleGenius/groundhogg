var wpghImportExport;!function($){wpghImportExport={completedRows:0,allRows:0,status:null,results:null,import_id:null,init:function(){$(".import").on("click",function(){wpghImportExport.load()}),$(".export").on("click",function(){wpghImportExport.export("wpgh_export_contacts")}),$(".query-export").on("click",function(){wpghImportExport.export("wpgh_query_export_contacts")}),$(".delete").on("click",function(){wpghImportExport.bulkDelete()}),this.status=$(".import-status"),console.log("Importer Ready")},load:function(){$("input[type=file]").parse({config:{download:!0,delimiter:",",header:!0,complete:function(t,e){console.log("This file done:",e,t),wpghImportExport.allRows=t.data.length,wpghImportExport.results=t.data,wpghImportExport.completedRows=0}},complete:function(){wpghImportExport.import_id=wpghImportExport.guidGenerator(),wpghImportExport.import()}})},import:function(){for($(".spinner-import").css("visibility","visible");this.results.length>0;){var t=50;this.results.length<50&&(t=this.results.length);var e=this.results.splice(0,t);this.send(e)}},send:function(t){var e=$("#import_tags").val();$.ajax({type:"post",url:ajaxurl,dataType:"json",data:{action:"wpgh_import_contacts",data:t,tags:e,import_id:this.import_id},success:function(t){void 0!==t.contacts?(wpghImportExport.completedRows+=t.contacts,wpghImportExport.updateStatus()):(console.log(t),alert(t),$(".spinner-import").css("visibility","hidden"))}})},updateStatus:function(){var t=Math.ceil(this.completedRows/this.allRows*100);(this.status.html("Status: "+t+"%"),console.log("Status: "+t+"%"),t>=100)&&$(".spinner-import").css("visibility","hidden")},export:function(t){var e=$("#export_tags").val();this.retrieve(t,e)},retrieve:function(t,e){var o=$(".spinner-export");o.css("visibility","visible"),$.ajax({type:"post",url:ajaxurl,dataType:"json",data:{action:t,tags:e},success:function(t){var e=Papa.unparse(t,{quotes:!1,quoteChar:'"',escapeChar:'"',delimiter:",",header:!0,newline:"\r\n"});wpghImportExport.makeFile(e),o.css("visibility","hidden")}})},makeFile:function(t){var e=document.createElement("a");e.setAttribute("href","data:text/csv;charset=utf-8,"+encodeURIComponent(t));var o=new Date,i=o.getFullYear()+"-"+(o.getMonth()+1)+"-"+o.getDate()+" "+(o.getHours()+":"+o.getMinutes()+":"+o.getSeconds());e.setAttribute("download","contacts-"+i+".csv"),e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e)},bulkDelete:function(){var t=$("#delete_tags").val(),e=$(".spinner-delete");e.css("visibility","visible"),$.ajax({type:"post",url:ajaxurl,data:{action:"wpgh_bulk_delete_contacts",tags:t},success:function(t){alert(t),$("#delete_tags").val("").change(),e.css("visibility","hidden")}})},guidGenerator:function(){var t=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()}},$(function(){wpghImportExport.init()})}(jQuery);