{"version":3,"sources":["@wordpress/block-editor/src/components/observe-typing/index.js"],"names":["KEY_DOWN_ELIGIBLE_KEY_CODES","UP","RIGHT","DOWN","LEFT","ENTER","BACKSPACE","isKeyDownEligibleForStartTyping","event","keyCode","shiftKey","includes","ObserveTyping","children","setSafeTimeout","setTimeout","typingContainer","lastMouseMove","isTyping","select","startTyping","stopTyping","toggleEventBindings","isBound","bindFn","current","ownerDocument","stopTypingOnSelectionUncollapse","stopTypingOnMouseMove","document","clientX","clientY","lastClientX","lastClientY","target","selection","defaultView","getSelection","isCollapsed","rangeCount","getRangeAt","collapsed","stopTypingOnEscapeKey","ESCAPE","TAB","startTypingInTextField","type","contains","stopTypingOnNonTextField"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport { over } from 'lodash';\n\n/**\n * WordPress dependencies\n */\nimport { useRef, useEffect } from '@wordpress/element';\nimport { useSelect, useDispatch } from '@wordpress/data';\nimport { isTextField } from '@wordpress/dom';\nimport {\n\tUP,\n\tRIGHT,\n\tDOWN,\n\tLEFT,\n\tENTER,\n\tBACKSPACE,\n\tESCAPE,\n\tTAB,\n} from '@wordpress/keycodes';\nimport { withSafeTimeout } from '@wordpress/compose';\n\n/**\n * Set of key codes upon which typing is to be initiated on a keydown event.\n *\n * @type {number[]}\n */\nconst KEY_DOWN_ELIGIBLE_KEY_CODES = [ UP, RIGHT, DOWN, LEFT, ENTER, BACKSPACE ];\n\n/**\n * Returns true if a given keydown event can be inferred as intent to start\n * typing, or false otherwise. A keydown is considered eligible if it is a\n * text navigation without shift active.\n *\n * @param {KeyboardEvent} event Keydown event to test.\n *\n * @return {boolean} Whether event is eligible to start typing.\n */\nfunction isKeyDownEligibleForStartTyping( event ) {\n\tconst { keyCode, shiftKey } = event;\n\treturn ! shiftKey && KEY_DOWN_ELIGIBLE_KEY_CODES.includes( keyCode );\n}\n\nfunction ObserveTyping( { children, setTimeout: setSafeTimeout } ) {\n\tconst typingContainer = useRef();\n\tconst lastMouseMove = useRef();\n\tconst isTyping = useSelect( ( select ) =>\n\t\tselect( 'core/block-editor' ).isTyping()\n\t);\n\tconst { startTyping, stopTyping } = useDispatch( 'core/block-editor' );\n\tuseEffect( () => {\n\t\ttoggleEventBindings( isTyping );\n\t\treturn () => toggleEventBindings( false );\n\t}, [ isTyping ] );\n\n\t/**\n\t * Bind or unbind events to the document when typing has started or stopped\n\t * respectively, or when component has become unmounted.\n\t *\n\t * @param {boolean} isBound Whether event bindings should be applied.\n\t */\n\tfunction toggleEventBindings( isBound ) {\n\t\tconst bindFn = isBound ? 'addEventListener' : 'removeEventListener';\n\t\ttypingContainer.current.ownerDocument[ bindFn ](\n\t\t\t'selectionchange',\n\t\t\tstopTypingOnSelectionUncollapse\n\t\t);\n\t\ttypingContainer.current.ownerDocument[ bindFn ](\n\t\t\t'mousemove',\n\t\t\tstopTypingOnMouseMove\n\t\t);\n\t\tdocument[ bindFn ]( 'mousemove', stopTypingOnMouseMove );\n\t}\n\n\t/**\n\t * On mouse move, unset typing flag if user has moved cursor.\n\t *\n\t * @param {MouseEvent} event Mousemove event.\n\t */\n\tfunction stopTypingOnMouseMove( event ) {\n\t\tconst { clientX, clientY } = event;\n\n\t\t// We need to check that the mouse really moved because Safari triggers\n\t\t// mousemove events when shift or ctrl are pressed.\n\t\tif ( lastMouseMove.current ) {\n\t\t\tconst {\n\t\t\t\tclientX: lastClientX,\n\t\t\t\tclientY: lastClientY,\n\t\t\t} = lastMouseMove.current;\n\n\t\t\tif ( lastClientX !== clientX || lastClientY !== clientY ) {\n\t\t\t\tstopTyping();\n\t\t\t}\n\t\t}\n\n\t\tlastMouseMove.current = { clientX, clientY };\n\t}\n\n\t/**\n\t * On selection change, unset typing flag if user has made an uncollapsed\n\t * (shift) selection.\n\t */\n\tfunction stopTypingOnSelectionUncollapse( { target } ) {\n\t\tconst selection = target.defaultView.getSelection();\n\t\tconst isCollapsed =\n\t\t\tselection.rangeCount > 0 && selection.getRangeAt( 0 ).collapsed;\n\n\t\tif ( ! isCollapsed ) {\n\t\t\tstopTyping();\n\t\t}\n\t}\n\n\t/**\n\t * Unsets typing flag if user presses Escape while typing flag is active.\n\t *\n\t * @param {KeyboardEvent} event Keypress or keydown event to interpret.\n\t */\n\tfunction stopTypingOnEscapeKey( event ) {\n\t\tif (\n\t\t\tisTyping &&\n\t\t\t( event.keyCode === ESCAPE || event.keyCode === TAB )\n\t\t) {\n\t\t\tstopTyping();\n\t\t}\n\t}\n\n\t/**\n\t * Handles a keypress or keydown event to infer intention to start typing.\n\t *\n\t * @param {KeyboardEvent} event Keypress or keydown event to interpret.\n\t */\n\tfunction startTypingInTextField( event ) {\n\t\tconst { type, target } = event;\n\n\t\t// Abort early if already typing, or key press is incurred outside a\n\t\t// text field (e.g. arrow-ing through toolbar buttons).\n\t\t// Ignore typing if outside the current DOM container\n\t\tif (\n\t\t\tisTyping ||\n\t\t\t! isTextField( target ) ||\n\t\t\t! typingContainer.current.contains( target )\n\t\t) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Special-case keydown because certain keys do not emit a keypress\n\t\t// event. Conversely avoid keydown as the canonical event since there\n\t\t// are many keydown which are explicitly not targeted for typing.\n\t\tif (\n\t\t\ttype === 'keydown' &&\n\t\t\t! isKeyDownEligibleForStartTyping( event )\n\t\t) {\n\t\t\treturn;\n\t\t}\n\n\t\tstartTyping();\n\t}\n\n\t/**\n\t * Stops typing when focus transitions to a non-text field element.\n\t *\n\t * @param {FocusEvent} event Focus event.\n\t */\n\tfunction stopTypingOnNonTextField( event ) {\n\t\tconst { target } = event;\n\n\t\t// Since focus to a non-text field via arrow key will trigger before\n\t\t// the keydown event, wait until after current stack before evaluating\n\t\t// whether typing is to be stopped. Otherwise, typing will re-start.\n\t\tsetSafeTimeout( () => {\n\t\t\tif ( isTyping && ! isTextField( target ) ) {\n\t\t\t\tstopTyping();\n\t\t\t}\n\t\t} );\n\t}\n\n\t// Disable reason: This component is responsible for capturing bubbled\n\t// keyboard events which are interpreted as typing intent.\n\n\t/* eslint-disable jsx-a11y/no-static-element-interactions */\n\treturn (\n\t\t<div\n\t\t\tref={ typingContainer }\n\t\t\tonFocus={ stopTypingOnNonTextField }\n\t\t\tonKeyPress={ startTypingInTextField }\n\t\t\tonKeyDown={ over( [\n\t\t\t\tstartTypingInTextField,\n\t\t\t\tstopTypingOnEscapeKey,\n\t\t\t] ) }\n\t\t>\n\t\t\t{ children }\n\t\t</div>\n\t);\n\t/* eslint-enable jsx-a11y/no-static-element-interactions */\n}\n\n/**\n * @see https://github.com/WordPress/gutenberg/blob/master/packages/block-editor/src/components/observe-typing/README.md\n */\nexport default withSafeTimeout( ObserveTyping );\n"]}