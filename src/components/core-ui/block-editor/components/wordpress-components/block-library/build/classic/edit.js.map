{"version":3,"sources":["@wordpress/block-library/src/classic/edit.js"],"names":["window","wp","isTmceEmpty","editor","body","getBody","childNodes","length","test","innerText","textContent","ClassicEdit","props","initialize","bind","onSetup","focus","wpEditorL10n","tinymce","baseURL","suffix","EditorManager","overrideDefaults","base_url","document","readyState","addEventListener","oldEditor","remove","clientId","prevProps","content","attributes","get","currentContent","getContent","setContent","settings","inline","content_css","fixed_toolbar_container","setup","setAttributes","bookmark","on","selection","getBookmark","scrollContainer","querySelector","scrollPosition","scrollTop","once","moveToBookmark","debouncedOnChange","value","_lastChange","cancel","event","isKeyboardEvent","primary","stopPropagation","keyCode","BACKSPACE","DELETE","onReplace","preventDefault","stopImmediatePropagation","altKey","F10","rootNode","ownerDocument","activeElement","blur","nativeEvent","onToolbarKeyDown","Component"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport { debounce } from 'lodash';\n\n/**\n * WordPress dependencies\n */\nimport { BlockControls } from '@wordpress/block-editor';\nimport { ToolbarGroup } from '@wordpress/components';\nimport { Component } from '@wordpress/element';\nimport { __ } from '@wordpress/i18n';\nimport { BACKSPACE, DELETE, F10, isKeyboardEvent } from '@wordpress/keycodes';\n\n/**\n * Internal dependencies\n */\nimport ConvertToBlocksButton from './convert-to-blocks-button';\n\nconst { wp } = window;\n\nfunction isTmceEmpty( editor ) {\n\t// When tinyMce is empty the content seems to be:\n\t// <p><br data-mce-bogus=\"1\"></p>\n\t// avoid expensive checks for large documents\n\tconst body = editor.getBody();\n\tif ( body.childNodes.length > 1 ) {\n\t\treturn false;\n\t} else if ( body.childNodes.length === 0 ) {\n\t\treturn true;\n\t}\n\tif ( body.childNodes[ 0 ].childNodes.length > 1 ) {\n\t\treturn false;\n\t}\n\treturn /^\\n?$/.test( body.innerText || body.textContent );\n}\n\nexport default class ClassicEdit extends Component {\n\tconstructor( props ) {\n\t\tsuper( props );\n\t\tthis.initialize = this.initialize.bind( this );\n\t\tthis.onSetup = this.onSetup.bind( this );\n\t\tthis.focus = this.focus.bind( this );\n\t}\n\n\tcomponentDidMount() {\n\t\tconst { baseURL, suffix } = window.wpEditorL10n.tinymce;\n\n\t\twindow.tinymce.EditorManager.overrideDefaults( {\n\t\t\tbase_url: baseURL,\n\t\t\tsuffix,\n\t\t} );\n\n\t\tif ( document.readyState === 'complete' ) {\n\t\t\tthis.initialize();\n\t\t} else {\n\t\t\tdocument.addEventListener( 'readystatechange', () => {\n\t\t\t\tif ( document.readyState === 'complete' ) {\n\t\t\t\t\tthis.initialize();\n\t\t\t\t}\n\t\t\t} );\n\t\t}\n\t}\n\n\tcomponentWillUnmount() {\n\t\twindow.addEventListener( 'DOMContentLoaded', this.initialize );\n\t\twp.oldEditor.remove( `editor-${ this.props.clientId }` );\n\t}\n\n\tcomponentDidUpdate( prevProps ) {\n\t\tconst {\n\t\t\tclientId,\n\t\t\tattributes: { content },\n\t\t} = this.props;\n\n\t\tconst editor = window.tinymce.get( `editor-${ clientId }` );\n\t\tconst currentContent = editor?.getContent();\n\n\t\tif (\n\t\t\tprevProps.attributes.content !== content &&\n\t\t\tcurrentContent !== content\n\t\t) {\n\t\t\teditor.setContent( content || '' );\n\t\t}\n\t}\n\n\tinitialize() {\n\t\tconst { clientId } = this.props;\n\t\tconst { settings } = window.wpEditorL10n.tinymce;\n\t\twp.oldEditor.initialize( `editor-${ clientId }`, {\n\t\t\ttinymce: {\n\t\t\t\t...settings,\n\t\t\t\tinline: true,\n\t\t\t\tcontent_css: false,\n\t\t\t\tfixed_toolbar_container: `#toolbar-${ clientId }`,\n\t\t\t\tsetup: this.onSetup,\n\t\t\t},\n\t\t} );\n\t}\n\n\tonSetup( editor ) {\n\t\tconst {\n\t\t\tattributes: { content },\n\t\t\tsetAttributes,\n\t\t} = this.props;\n\t\tlet bookmark;\n\n\t\tthis.editor = editor;\n\n\t\tif ( content ) {\n\t\t\teditor.on( 'loadContent', () => editor.setContent( content ) );\n\t\t}\n\n\t\teditor.on( 'blur', () => {\n\t\t\tbookmark = editor.selection.getBookmark( 2, true );\n\t\t\t// There is an issue with Chrome and the editor.focus call in core at https://core.trac.wordpress.org/browser/trunk/src/js/_enqueues/lib/link.js#L451.\n\t\t\t// This causes a scroll to the top of editor content on return from some content updating dialogs so tracking\n\t\t\t// scroll position until this is fixed in core.\n\t\t\tconst scrollContainer = document.querySelector(\n\t\t\t\t'.interface-interface-skeleton__content'\n\t\t\t);\n\t\t\tconst scrollPosition = scrollContainer.scrollTop;\n\n\t\t\tsetAttributes( {\n\t\t\t\tcontent: editor.getContent(),\n\t\t\t} );\n\n\t\t\teditor.once( 'focus', () => {\n\t\t\t\tif ( bookmark ) {\n\t\t\t\t\teditor.selection.moveToBookmark( bookmark );\n\t\t\t\t\tif ( scrollContainer.scrollTop !== scrollPosition ) {\n\t\t\t\t\t\tscrollContainer.scrollTop = scrollPosition;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} );\n\n\t\t\treturn false;\n\t\t} );\n\n\t\teditor.on( 'mousedown touchstart', () => {\n\t\t\tbookmark = null;\n\t\t} );\n\n\t\tconst debouncedOnChange = debounce( () => {\n\t\t\tconst value = editor.getContent();\n\n\t\t\tif ( value !== editor._lastChange ) {\n\t\t\t\teditor._lastChange = value;\n\t\t\t\tsetAttributes( {\n\t\t\t\t\tcontent: value,\n\t\t\t\t} );\n\t\t\t}\n\t\t}, 250 );\n\t\teditor.on( 'Paste Change input Undo Redo', debouncedOnChange );\n\n\t\t// We need to cancel the debounce call because when we remove\n\t\t// the editor (onUnmount) this callback is executed in\n\t\t// another tick. This results in setting the content to empty.\n\t\teditor.on( 'remove', debouncedOnChange.cancel );\n\n\t\teditor.on( 'keydown', ( event ) => {\n\t\t\tif ( isKeyboardEvent.primary( event, 'z' ) ) {\n\t\t\t\t// Prevent the gutenberg undo kicking in so TinyMCE undo stack works as expected\n\t\t\t\tevent.stopPropagation();\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\t( event.keyCode === BACKSPACE || event.keyCode === DELETE ) &&\n\t\t\t\tisTmceEmpty( editor )\n\t\t\t) {\n\t\t\t\t// delete the block\n\t\t\t\tthis.props.onReplace( [] );\n\t\t\t\tevent.preventDefault();\n\t\t\t\tevent.stopImmediatePropagation();\n\t\t\t}\n\n\t\t\tconst { altKey } = event;\n\t\t\t/*\n\t\t\t * Prevent Mousetrap from kicking in: TinyMCE already uses its own\n\t\t\t * `alt+f10` shortcut to focus its toolbar.\n\t\t\t */\n\t\t\tif ( altKey && event.keyCode === F10 ) {\n\t\t\t\tevent.stopPropagation();\n\t\t\t}\n\t\t} );\n\n\t\teditor.on( 'init', () => {\n\t\t\tconst rootNode = this.editor.getBody();\n\n\t\t\t// Create the toolbar by refocussing the editor.\n\t\t\tif ( rootNode.ownerDocument.activeElement === rootNode ) {\n\t\t\t\trootNode.blur();\n\t\t\t\tthis.editor.focus();\n\t\t\t}\n\t\t} );\n\t}\n\n\tfocus() {\n\t\tif ( this.editor ) {\n\t\t\tthis.editor.focus();\n\t\t}\n\t}\n\n\tonToolbarKeyDown( event ) {\n\t\t// Prevent WritingFlow from kicking in and allow arrows navigation on the toolbar.\n\t\tevent.stopPropagation();\n\t\t// Prevent Mousetrap from moving focus to the top toolbar when pressing `alt+f10` on this block toolbar.\n\t\tevent.nativeEvent.stopImmediatePropagation();\n\t}\n\n\trender() {\n\t\tconst { clientId } = this.props;\n\n\t\t// Disable reasons:\n\t\t//\n\t\t// jsx-a11y/no-static-element-interactions\n\t\t//  - the toolbar itself is non-interactive, but must capture events\n\t\t//    from the KeyboardShortcuts component to stop their propagation.\n\n\t\t/* eslint-disable jsx-a11y/no-static-element-interactions */\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<BlockControls>\n\t\t\t\t\t<ToolbarGroup>\n\t\t\t\t\t\t<ConvertToBlocksButton clientId={ clientId } />\n\t\t\t\t\t</ToolbarGroup>\n\t\t\t\t</BlockControls>\n\t\t\t\t<div\n\t\t\t\t\tkey=\"toolbar\"\n\t\t\t\t\tid={ `toolbar-${ clientId }` }\n\t\t\t\t\tclassName=\"block-library-classic__toolbar\"\n\t\t\t\t\tonClick={ this.focus }\n\t\t\t\t\tdata-placeholder={ __( 'Classic' ) }\n\t\t\t\t\tonKeyDown={ this.onToolbarKeyDown }\n\t\t\t\t/>\n\t\t\t\t<div\n\t\t\t\t\tkey=\"editor\"\n\t\t\t\t\tid={ `editor-${ clientId }` }\n\t\t\t\t\tclassName=\"wp-block-freeform block-library-rich-text__tinymce\"\n\t\t\t\t/>\n\t\t\t</>\n\t\t);\n\t\t/* eslint-enable jsx-a11y/no-static-element-interactions */\n\t}\n}\n"]}